{% extends 'base.html' %}
{% load static %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ìƒì„¸</title>    
    
    <style>
        main {
            padding: 40px;
            height: 100%;
        }
    
        img {
            margin: 20px 0;
        }
    </style>
{% endblock%}


{% block content %}
<h1 style="color: green; font-size: 40px">{{post.title}}</h1>

{% if post.photo %}
<img src="{{post.photo.url}}" alt="ì œí’ˆ ì´ë¯¸ì§€" />
{% else %}
<img src="{% static 'posts/image/no-image.jpg' %}" alt="ëŒ€ì²´ í…ìŠ¤íŠ¸" />
{% endif %}

<p>ì‘ì„±ì: {{post.user}}</p>
<p>ì§€ì—­: {{post.region}}</p>
<p>ê°€ê²©: {{post.price}}</p>
<h2 class="my-3">{{post.content}}</h2>
<p>ì‘ì„±ì¼: {{post.created_at}}</p>
<p>ìˆ˜ì •ì¼: {{post.updated_at}}</p>
<p>ì´ ì‘ì„±ìì˜ ê¸€</p>
{% if post.ingredient_image %}
        <div class="info-row">
            <div class="info-label">ì˜ì–‘ì„±ë¶„í‘œ:</div>
            <div class="info-value">
                <div class="image-container">
                    <img src="{{ post.ingredient_image.url }}" alt="ì˜ì–‘ì„±ë¶„í‘œ">
                </div>
            </div>
        </div>
        {% endif %}



        <!-- ì˜ì–‘ ì„±ë¶„ ì„¹ì…˜ -->
        <div class="nutrition-section">
            <div class="nutrition-title">
                ğŸ“Š ì˜ì–‘ ì„±ë¶„ ì •ë³´
                <span id="analysis-status"></span>
            </div>
            
            <div id="nutrition-content">
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <div class="nutrition-label">ì¹¼ë¡œë¦¬</div>
                        <div class="nutrition-value">
                            <span id="calories">{{ post.calories_kcal|default:"0" }}</span>
                            <span class="nutrition-unit">kcal</span>
                        </div>
                    </div>
                    
                    <div class="nutrition-item">
                        <div class="nutrition-label">íƒ„ìˆ˜í™”ë¬¼</div>
                        <div class="nutrition-value">
                            <span id="carbs">{{ post.carbs_g|default:"0" }}</span>
                            <span class="nutrition-unit">g</span>
                        </div>
                    </div>
                    
                    <div class="nutrition-item">
                        <div class="nutrition-label">ë‹¨ë°±ì§ˆ</div>
                        <div class="nutrition-value">
                            <span id="protein">{{ post.protein_g|default:"0" }}</span>
                            <span class="nutrition-unit">g</span>
                        </div>
                    </div>
                    
                    <div class="nutrition-item">
                        <div class="nutrition-label">ì§€ë°©</div>
                        <div class="nutrition-value">
                            <span id="fat">{{ post.fat_g|default:"0" }}</span>
                            <span class="nutrition-unit">g</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error-message" style="display: none;" class="error-message"></div>
        </div>
{% endblock %}


{% block extra_js %}
<script>
let pollInterval;

function checkAnalysisStatus() {
  const url = "{% url 'posts:analysis_status' post.id %}";

  fetch(url)
    .then(r => r.json())
    .then(data => {
      const statusElement = document.getElementById('analysis-status');
      const errorElement = document.getElementById('error-message');

      if (data.status === 'processing') {
        statusElement.innerHTML = `
          <span class="analyzing">
            <div class="spinner"></div>
            ë¶„ì„ ì¤‘...
          </span>`;
      } else if (data.status === 'done') {   // âœ… ì—¬ê¸°
        statusElement.innerHTML = '<span style="color:#28a745;">âœ“ ë¶„ì„ ì™„ë£Œ</span>';

        document.getElementById('calories').textContent = data.calories_kcal ?? '0';
        document.getElementById('carbs').textContent = data.carbs_g ?? '0';
        document.getElementById('protein').textContent = data.protein_g ?? '0';
        document.getElementById('fat').textContent = data.fat_g ?? '0';

        clearInterval(pollInterval);
        setTimeout(() => statusElement.innerHTML = '', 3000);
      } else if (data.status === 'failed') {
        statusElement.innerHTML = '<span style="color:#dc3545;">âœ— ë¶„ì„ ì‹¤íŒ¨</span>';
        errorElement.textContent = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        errorElement.style.display = 'block';
        clearInterval(pollInterval);
      }
    })
    .catch(err => console.error(err));
}

window.addEventListener('DOMContentLoaded', () => {
  const initialStatus = '{{ post.analysis_status }}';
  if (initialStatus === 'processing') {
    checkAnalysisStatus();
    pollInterval = setInterval(checkAnalysisStatus, 2000);
  }
});
</script>
{% endblock %}



<hr />
<a href="{% url 'posts:update' post.pk %}" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</a>
<a href="{% url 'posts:delete' post.pk %}" class="btn btn-danger">ì‚­ì œí•˜ê¸°</a>
{% endblock content %}