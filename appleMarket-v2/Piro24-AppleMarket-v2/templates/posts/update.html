{% extends 'base.html' %}

{% block head %}
<title>post_detail</title>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
<style>
    main {
        height: 100vh;
        padding: 40px;
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
                <label class="form-label" for="{{ form.title.id_for_label }}">ì œëª©:</label>
                {{ form.title }}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.content.id_for_label }}">ë‚´ìš©:</label>
                {{ form.content }}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.region.id_for_label }}">ì§€ì—­:</label>
                {{ form.region }}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.author.id_for_label }}">ì‘ì„±ì:</label>
                {{ form.user }}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.price.id_for_label }}">ê°€ê²©:</label>
                {{ form.price }}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.image.id_for_label }}">ì´ë¯¸ì§€:</label>
                {{ form.photo }}
                {% if post.photo %}
                    <p class="helper-text">í˜„ì¬ ì´ë¯¸ì§€:</p>
                    <img src="{{ post.photo.url }}" alt="í˜„ì¬ ì´ë¯¸ì§€" class="current-image">
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.ingredient_image.id_for_label }}">ì˜ì–‘ì„±ë¶„í‘œ ì´ë¯¸ì§€:</label>
                {{ form.ingredient_image }}
                {% if post.ingredient_image %}
                    <p class="helper-text">í˜„ì¬ ì˜ì–‘ì„±ë¶„í‘œ ì´ë¯¸ì§€:</p>
                    <img src="{{ post.ingredient_image.url }}" alt="ì˜ì–‘ì„±ë¶„í‘œ" class="current-image">
                    <p class="helper-text" style="color: #dc3545;">âš ï¸ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•˜ë©´ ì˜ì–‘ ì„±ë¶„ì´ ìë™ìœ¼ë¡œ ì¬ë¶„ì„ë©ë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            
            <!-- ì˜ì–‘ ì„±ë¶„ ì„¹ì…˜ (ìˆ˜ì • ê°€ëŠ¥) -->
            <div class="nutrition-section">
                <div class="nutrition-title">
                    ğŸ“Š ì˜ì–‘ ì„±ë¶„ ì •ë³´
                    <span id="analysis-status"></span>
                </div>
                <p class="helper-text">OCRë¡œ ìë™ ì…ë ¥ëœ ê°’ì„ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <div class="nutrition-grid">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.calories_kcal.id_for_label }}">ì¹¼ë¡œë¦¬ (kcal):</label>
                        {{ form.calories_kcal }}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.carbs_g.id_for_label }}">íƒ„ìˆ˜í™”ë¬¼ (g):</label>
                        {{ form.carbs_g }}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.protein_g.id_for_label }}">ë‹¨ë°±ì§ˆ (g):</label>
                        {{ form.protein_g }}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.fat_g.id_for_label }}">ì§€ë°© (g):</label>
                        {{ form.fat_g }}
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="{{ form.hashtag.id_for_label }}">ìƒí’ˆ ì¢…ë¥˜ í•´ì‹œíƒœê·¸:</label>
                {{ form.hashtag }}
            </div>
            
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</button>
                <a href="{% url 'posts:detail' post.id %}" class="btn btn-secondary">ì·¨ì†Œ</a>
            </div>
        </form>
{%endblock%}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const imgInput = document.querySelector('input[name="ingredient_image"]');
  const calories = document.querySelector('input[name="calories_kcal"]');
  const carbs = document.querySelector('input[name="carbs_g"]');
  const protein = document.querySelector('input[name="protein_g"]');
  const fat = document.querySelector('input[name="fat_g"]');

  if (!imgInput) return;

  function setAnalyzing() {
    [calories, carbs, protein, fat].forEach(el => {
      if (!el) return;
      el.value = "";                       // âœ… ê°’ì€ ë¹„ìš°ê¸°
      el.placeholder = "ë¶„ì„ ì¤‘...";       // âœ… placeholderë¡œ í‘œì‹œ
      el.disabled = true; 
    });
  }

  function setValues(data) {
    [calories, carbs, protein, fat].forEach(el => {
    if (!el) return;
    el.disabled = false;
    el.placeholder = "";
  });
    if (calories) calories.value = (data.calories_kcal ?? "") === null ? "" : (data.calories_kcal ?? "");
    if (carbs) carbs.value = (data.carbs_g ?? "") === null ? "" : (data.carbs_g ?? "");
    if (protein) protein.value = (data.protein_g ?? "") === null ? "" : (data.protein_g ?? "");
    if (fat) fat.value = (data.fat_g ?? "") === null ? "" : (data.fat_g ?? "");
  }

  imgInput.addEventListener("change", async () => {
    if (!imgInput.files || !imgInput.files[0]) return;

    setAnalyzing();

    const fd = new FormData();
    fd.append("image", imgInput.files[0]);

    try {
      const res = await fetch("{% url 'posts:api_analyze_image' %}", {
        method: "POST",
        body: fd,
      });

      const json = await res.json();
      if (!res.ok || json.status !== "success") {
        alert(json.message || "ë¶„ì„ ì‹¤íŒ¨");
        setValues({});
        return;
      }
      setValues(json);
    } catch (e) {
      alert("ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      setValues({});
    }
  });
});
</script>



{% endblock %}