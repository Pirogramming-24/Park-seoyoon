{% extends 'base.html' %}
{% block head %}
<title>post_create</title>
<style>
    main {
        height: 100vh;
    }
</style>
{% endblock %}
{%block content%}
<div class="create-container">
    <h1 class="page-title">ğŸ ìƒí’ˆ ë“±ë¡</h1>
    
    <form id="create-form" action="{% url 'posts:create' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        
        <div class="btn-group">
            <button type="submit" id="submit-btn" class="btn btn-success">ë“±ë¡í•˜ê¸°</button>
            <a href="/" class="btn btn-secondary">ì·¨ì†Œ</a>
        </div>
    </form>
</div>

<!-- ë¶„ì„ ì˜¤ë²„ë ˆì´ -->
<div id="analysis-overlay">
    <div class="analysis-modal">
        <div class="spinner"></div>
        <p id="status-message">ğŸ” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const imgInput = document.querySelector('input[name="ingredient_image"]');
  const calories = document.querySelector('input[name="calories_kcal"]');
  const carbs = document.querySelector('input[name="carbs_g"]');
  const protein = document.querySelector('input[name="protein_g"]');
  const fat = document.querySelector('input[name="fat_g"]');

  if (!imgInput) return;

  function setAnalyzing() {
    [calories, carbs, protein, fat].forEach(el => {
      if(!el) return;
      el.value = "";
      el.placeholder = "ë¶„ì„ ì¤‘...";
      el.disabled = true;
    });
  }

  function setValues(data) {
    [calories, carbs, protein, fat].forEach(el => {
    if (!el) return;
    el.disabled = false;
    el.placeholder = "";
  });
    if (calories) calories.value = (data.calories_kcal ?? "") === null ? "" : (data.calories_kcal ?? "");
    if (carbs) carbs.value = (data.carbs_g ?? "") === null ? "" : (data.carbs_g ?? "");
    if (protein) protein.value = (data.protein_g ?? "") === null ? "" : (data.protein_g ?? "");
    if (fat) fat.value = (data.fat_g ?? "") === null ? "" : (data.fat_g ?? "");
  }

  imgInput.addEventListener("change", async () => {
    if (!imgInput.files || !imgInput.files[0]) return;

    setAnalyzing();

    const fd = new FormData();
    fd.append("image", imgInput.files[0]);

    try {
      const res = await fetch("{% url 'posts:api_analyze_image' %}", {
        method: "POST",
        body: fd,
      });

      const json = await res.json();
      if (!res.ok || json.status !== "success") {
        alert(json.message || "ë¶„ì„ ì‹¤íŒ¨");
        setValues({});
        return;
      }
      setValues(json);
    } catch (e) {
      alert("ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      setValues({});
    }
  });
});
const overlay = document.getElementById("analysis-overlay");
function showOverlay(){ if(overlay) overlay.style.display = "block"; }
function hideOverlay(){ if(overlay) overlay.style.display = "none"; }
</script>


{% endblock %}